---

layout: post
title: "Pycharm 02"
categories: Archives
tags: [documentation,Pycharm]
image:
 feature:
 teaser:
 credit:
 creditlink:

---

#### Time : 2018-05-20
#### Title : Pycharm - 02
- 파이썬으로 배우는 알고리즘 트레이딩 실전 예를 작성해보면서 익히려고 한다.
- 여기서는 실제로 툴을 만들어보면서 작성한 내용을 적으려고한다.
- 난 계정이 없기 때문에 똑같이 따라하기는 힘들것 같다.
- 우선 실전프로그램을 보면서 따라할수 있는것은하고 필요없는 부분은 패스 한다.(https://wikidocs.net/2878)
^화살표위 = shift+ctrl

1. 창에서 또다른 창 띄우는것은?
- [PyQt : Open Other Window When Button Clicked](https://www.youtube.com/watch?v=dRRpbDFnMHI&t=354s)
- 매우 짧은 동영상 강의임.

~~~ python
    from otherwindow import Ui_otherwindow
    # 이 구문을 보면 from 파일이름 import 클래스 이름 구조인것을 알 우 있음.
    def openWindow(self):
        self.window = QtWidgets.QMainWindow()
        self.ui = Ui_otherwindow()
        self.ui.setupUi(self.window)
        MainWindow.hide()
        self.window.show()

    self.pushButton.clicked.connect(self.openWindow)
~~~
- MainWindow.py에 위 구문을 추가하면 새로운 창을 띄울 수 있다. 그러나 치명적인 단점이 내가 GUI를 수정하고
- pyuic5 -x mainwindow.ui -o mainwindow.py
- 해당 명령어로 mainwindow.py 파일을 만들면 다 사라진다. 이게 멍미 ㅡㅡ....

2. 파일을 이용해서 1.에서 구현한거 똑 같이 구현하기
- 위에 적은거 처럼 pyuic5 -x mainwindow.ui -o mainwindow.py 식으로 파일을 만들면 기존에 만든것이 다 사라진다.

~~~ python
  import sys
  from PyQt5.QtWidgets import *
  from PyQt5 import uic
  from PyQt5 import QtWidgets
  # Dialog 혹은 window여도 상관없음. 내가 추가로 만든Gui클래스를 import하고 띄우면됨.
  from otherwindow import Ui_otherwindow

  # 파일을 로드한다.
  form_class = uic.loadUiType("mainwindow.ui")[0]

  # form_class와 QMainWindow 다중 상속 받음.
  class mainwindow(QMainWindow, form_class):
      def __init__(self):
          super().__init__()
          self.setupUi(self)
          self.pushButton.clicked.connect(self.btn_clicked)

      def btn_clicked(self):
          self.window = QtWidgets.QDialog()
          self.ui = Ui_otherwindow()
          self.ui.setupUi(self.window)
          myWindow.hide()
          self.window.show()


  if __name__ == "__main__":
      app = QApplication(sys.argv)
      myWindow = mainwindow()
      myWindow.show()
      app.exec_()
~~~

3. 웹 페이지 크롤링
- [강좌 링크](https://wikidocs.net/6660)
- Beautiful Soup, Scarpy 등을 사용할 수 있지만 예제가 pandas이므로 "html5lib"를 설치해서 크롤링을 한다.
- 크롤링을 이해하는 것은 어렵다. 예제로 쑥쑥되면 좋겠지만 역시 기초가 다시 발목을 잡는다.
- 2장 웹페이지 크롤링 ~ 6장 배당률 기반 투자 알고리즘 구현을 차례대로 구현해보고 정리해서 적어보자.
- 언어도 말을해야 자기것이 되듯이 코드도 직접짜고 정리해봐야 내것이 된다.

- 2장 step1

~~~ python
  import pandas as pd

  df = pd.read_html("table.html")[0]
  print(df)
  print(df.index)
  print(df.columns)
  # 출력
  #print(df)
  0  years  2013  2014  2015
  1  sales   100   200   300
  #df.index
  RangeIndex(start=0, stop=2, step=1)
  #df.columns
  Int64Index([0, 1, 2, 3], dtype='int64')
~~~

- 2장 step2

~~~ python
  import requests

  import pandas as pd

  def get_financial_statements(code):
      url = "http://companyinfo.stock.naver.com/v1/company/ajax/cF1001.aspx?cmp_cd=%s&fin_typ=0&freq_typ=Y" % (code)
      print(url)
      html = requests.get(url).text
      html = html.replace('<th class="bg r01c02 endLine line-bottom"colspan="8">연간</th>', "")
      html = html.replace("<span class='span-sub'>(IFRS연결)</span>", "")
      html = html.replace('\t', '')
      html = html.replace('\n', '')
      html = html.replace('\r', '')
      html = html.replace('주요재무정보</th></tr><tr>', "주요재무정보</th>")

      for year in range(2009, 2021):
          for month in range(6, 13):
              month = "/%02d" % month
              html = html.replace(str(year) + month, str(year))

          for month in range(1, 6):
              month = "/%02d" % month
              html = html.replace(str(year + 1) + month, str(year))

          html = html.replace(str(year) + '(E)', str(year))

      df_list = pd.read_html(html)
      df = df_list[0]
      df_DataFrame= pd.DataFrame(df.get_values(), columns=df.columns.get_values(), index=df['주요재무정보'])

      print(df_DataFrame)
      print(df_DataFrame.columns)
      print(df_DataFrame.index)

  if __name__ == "__main__":
      get_financial_statements('035720')
~~~
- 여기까지만 해보면 의미를 좀 알 수 있음.
- 여기서 replace의 순서가 변경되면 잘 동작하지 않음. 그럼 위 같은 것은 어떻게 작성하냐?
- 구글에서 검색해보면 나옴. 그러나 그것을 보고 위처럼하기는 쉽지 않아 보임.
- DataFrame을 다시 생성했다. 이유는 read_html이 예제처럼 동작하지 않아서 index값을 가져오지 못했다.
- 이것때문에 고생을 좀 많이 했다.

- 3장/4장 배당률 기반 투자 알고리즘

- 이번 절에서는 앞서 파싱한 재무제표 데이터를 바탕으로 국채시가배당률이 높은 종목을 선정하는 프로그램을 구현하겠습니다.
- 아직 4장까지만 봤는데 5장6장을 봐야 전체를 이해할 수 있을듯 싶다.

~~~ python
  import requests

  import pandas as pd
  from bs4 import BeautifulSoup

  import numpy as np
  import datetime


  def get_financial_statements(code):
      url = "http://companyinfo.stock.naver.com/v1/company/ajax/cF1001.aspx?cmp_cd=%s&fin_typ=0&freq_typ=Y" % (code)
      print(url)
      html = requests.get(url).text
      html = html.replace('<th class="bg r01c02 endLine line-bottom"colspan="8">연간</th>', "")
      html = html.replace("<span class='span-sub'>(IFRS연결)</span>", "")
      html = html.replace("<span class='span-sub'>(IFRS별도)</span>", "")
      html = html.replace('\t', '')
      html = html.replace('\n', '')
      html = html.replace('\r', '')
      html = html.replace('주요재무정보</th></tr><tr>', "주요재무정보</th>")

      for year in range(2009, 2021):
          for month in range(6, 13):
              month = "/%02d" % month
              html = html.replace(str(year) + month, str(year))

          for month in range(1, 6):
              month = "/%02d" % month
              html = html.replace(str(year + 1) + month, str(year))

          html = html.replace(str(year) + '(E)', str(year))

      df_list = pd.read_html(html)
      df = df_list[0]
      df_DataFrame= pd.DataFrame(df.get_values(), columns=df.columns.get_values(), index=df['주요재무정보'])

      # print(df_DataFrame)
      # print(df_DataFrame.columns)
      # print(df_DataFrame.index)
      return df_DataFrame


  def get_3year_treasury():
      url = "http://www.index.go.kr/strata/jsp/showStblGams3.jsp?stts_cd=288401&idx_cd=2884&freq=Y&period=1998:2016"
      html = requests.get(url).text
      soup = BeautifulSoup(html, 'lxml')
      tr_data = soup.find_all('tr', id='tr_288401_1')
      td_data = tr_data[0].find_all('td')

      # print(td_data)
      print(td_data[0].text)

      treasury_3year = {}
      start_year = 1998

      for x in td_data:
          treasury_3year[start_year] = x.text
          start_year += 1
      print(treasury_3year)

  def get_dividend_yield(code):
      url = "http://companyinfo.stock.naver.com/company/c1010001.aspx?cmp_cd=" + code
      html = requests.get(url).text

      soup = BeautifulSoup(html, 'lxml')
      td_data = soup.find_all('td', {'class': 'cmp-table-cell td0301'})
      dt_data = td_data[0].find_all('dt')

      dividend_yield = dt_data[5].text
      dividend_yield = dividend_yield.split(' ')[1]
      dividend_yield = dividend_yield[:-1]

      print(dividend_yield)
      # return dividend_yield

  def get_current_3year_treasury():
      url = "http://info.finance.naver.com/marketindex/interestDailyQuote.nhn?marketindexCd=IRR_GOVT03Y&page=1"
      html = requests.get(url).text

      soup = BeautifulSoup(html, 'lxml')
      tbody_data = soup.find_all('tbody')
      tr_data = tbody_data[0].find_all('tr')
      td_data = tr_data[0].find_all('td')
      # return td_data[1].text
      print(td_data[1].text)

  def get_estimated_dividend_yield(code):
      df = get_financial_statements(code)
      dividend_yield = df.ix["현금배당수익률"]

      now = datetime.datetime.now()
      cur_year = now.year

      if str(cur_year) in dividend_yield.index:
          cur_year_dividend_yield = dividend_yield[str(cur_year)]
          if np.isnan(cur_year_dividend_yield):
              return dividend_yield[str(cur_year-1)]
          else:
              return cur_year_dividend_yield
      else:
          return dividend_yield[str(cur_year-1)]

  def get_previous_dividend_yield(code):
      df = get_financial_statements(code)
      dividend_yield = df.ix['현금배당수익률']

      now = datetime.datetime.now()
      cur_year = now.year

      previous_dividend_yield = {}

      for year in range(cur_year-5, cur_year):
          if str(year) in dividend_yield.index:
              previous_dividend_yield[year] = dividend_yield[str(year)]

      return previous_dividend_yield
  if __name__ == "__main__":
      # get_financial_statements('035720')
      # get_3year_treasury()
      # get_dividend_yield('058470')
      # get_current_3year_treasury()
      # estimate_dividedn_yield = get_estimated_dividend_yield('058470')
      estimate_dividedn_yield = get_previous_dividend_yield('058470')
      print(estimate_dividedn_yield)
~~~
- 우선 단위기능은 잘 돌아가는것을 확인하였다. 그러나 아직까지는 감이 안잡힘.
- 하나하나 기능을 보면 어렵지 않음. 그러나 조합이 중요하지....

- 5장 배당률 기반 투자 알고리즘 구현(2)

- 6장 배당률 기반 투자 알고리즘 구현(3)
